**THESE RULES ONLY APPLY TO FILES IN /halos-core-containers/**

# HaLOS Core Containers - Development Guide

## For Agentic Coding: Use the HaLOS Workspace

This repository should be used as part of the halos-distro workspace for AI-assisted development:

```bash
# Clone workspace and all repos
git clone https://github.com/hatlabs/halos-distro.git
cd halos-distro
./run repos:clone
```

See `halos-distro/docs/` for development workflows and guidance.

## About This Project

Core container application definitions for HaLOS. These apps are pre-installed in HaLOS images, not user-browsable through a store UI.

**Key difference from halos-marine-containers:** No `store/` directory - core apps are pre-installed, not discovered via store UI.

**Local Instructions**: For environment-specific instructions and configurations, see @CLAUDE.local.md (not committed to version control).

## Git Workflow Policy

**Branch Workflow:** Never push to main directly - always use feature branches and PRs.

**Link issues and PRs:** Always link related GitHub issues in PR descriptions with `Closes #<issue-number>`.

## Version Management

This repository uses the same versioning system as halos-marine-containers:

### VERSION File (Meta/Bundle Version)

The `VERSION` file is a **meta-version for git tags only**. It does NOT control Debian package versions.

- Used by CI to create git tags: `v{VERSION}+{N}_pre` and `v{VERSION}+{N}`
- Controls when new releases are triggered
- Bump this when you want a new release bundle

### App Package Versions

Individual apps in `apps/` have their own versions in `metadata.yaml`. These are independent of the VERSION file.

### Git Tags (auto-generated by CI)

- Pre-release: `v{VERSION}+{N}_pre` (unstable channel)
- Stable: `v{VERSION}+{N}` (stable channel)
- N = auto-calculated from existing git tags

## What This Repository Contains

**Container app definitions only** - no store package:
- **Core Apps** (`apps/`) - Pre-installed HaLOS applications
  - Homarr dashboard (main landing page)
  - Future: Traefik reverse proxy

## Repository Structure

```
halos-core-containers/
├── apps/                       # Container app definitions
│   ├── homarr/
│   ├── traefik/
│   └── authelia/
├── docker/                     # Docker build environment
│   ├── Dockerfile.debtools
│   └── docker-compose.debtools.yml
├── tools/
│   └── build-all.sh           # Build script (called by ./run)
├── .github/workflows/
│   └── main.yml               # CI/CD
├── run                        # Development commands (use this!)
└── README.md
```

## Adding a New Core App

1. Create `apps/<app-name>/` directory
2. Add `docker-compose.yml`, `config.yml`, `metadata.yaml`, `icon.png`
3. Build and test locally with `./run build <app-name>`
4. Deploy to test device with `./run deploy halos.local <app-name>`
5. Create PR - CI will build and validate

### App Definition Files

- **metadata.yaml**: Package info, version, description, tags (must include `field::core`)
- **docker-compose.yml**: Docker service definition
- **config.yml**: User-configurable settings (optional)
- **icon.png**: Application icon (256x256, PNG format)

## Local Development

**IMPORTANT**: Local development MUST use the `./run` script. This ensures consistent builds across all platforms (including macOS) by using a Docker-based build environment.

### First-time Setup

```bash
# Build the debtools Docker image (required once)
./run build-debtools
```

### Building Packages

```bash
# Build all packages
./run build-all

# Build a specific app
./run build homarr
./run build traefik
./run build authelia

# Output: build/*.deb
```

### Deploying for Testing

```bash
# Deploy all packages to a remote host
./run deploy halos.local

# Deploy a specific app
./run deploy halos.local homarr
```

### Other Commands

```bash
# Open interactive shell in build container
./run shell

# List available apps
./run list-apps

# Clean build artifacts
./run clean

# Show help
./run help
```

### Why Docker?

- `dpkg-buildpackage` is not available on macOS
- Ensures consistent Debian Trixie build environment
- Matches CI/CD environment exactly
- Prevents "works on my machine" issues

**CI/CD**: GitHub Actions builds on push and creates releases.

## Related

- **Parent**: [../AGENTS.md](../AGENTS.md) - Workspace documentation
- **Sibling**: [halos-marine-containers](https://github.com/hatlabs/halos-marine-containers) - Marine container store
- **Tooling**: [container-packaging-tools](https://github.com/hatlabs/container-packaging-tools)
